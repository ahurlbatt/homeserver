- name: Copy compose file
  ansible.builtin.copy:
    src: "{{ playbook_dir}}/../containers/{{ container_name }}/compose.yaml"
    dest: "{{ container_directory }}/{{ container_name }}/"
    mode: 0644

- name: Copy files from the configuration directory
  ansible.builtin.copy:
    src: "{{ configuration_directory }}"
    dest: "{{ container_directory }}/{{ container_name }}/"
    mode: 0644
  vars:
    - configuration_directory: "{{ playbook_dir}}/../containers/{{ container_name }}/configuration/"
  when: configuration_directory is directory

- name: Make any directories that are needed by template files
  ansible.builtin.file:
    path: "{{ container_directory }}/{{ container_name }}/{{ template_directory.path }}"
    state: directory
    mode: 0755
  with_filetree: "{{ templates_root }}"
  loop_control:
    loop_var: template_directory
  when: template_directory.state == 'directory'
  vars:
    - templates_root: "{{ playbook_dir}}/../containers/{{ container_name }}/templates/"

- name: Template files from the template directory
  ansible.builtin.template:
    src: "{{ template_file.src }}"
    dest: "{{ container_directory }}/{{ container_name }}/{{ template_file.path }}"
    mode: 0644
  with_filetree: "{{ templates_root }}"
  loop_control:
    loop_var: template_file
  when: template_file.state == 'file'
  vars:
    - templates_root: "{{ playbook_dir}}/../containers/{{ container_name }}/templates/"

- name: Unset required secrets
  ansible.builtin.set_fact:
    required_secrets: "{{ [] }}"

- name: Get required secrets
  ansible.builtin.set_fact:
    required_secrets: "{{ lookup('file', required_secrets_file).splitlines() }}"
  when: required_secrets_file is file
  vars:
    - required_secrets_file: "{{ playbook_dir}}/../containers/{{ container_name }}/required_secrets.txt"

- name: Make secrets directory if we have secrets
  ansible.builtin.file:
    path: "{{ container_directory }}/{{ container_name }}/secrets/"
    state: directory
    mode: 0700
  when: required_secrets|length is gt(0)

- name: Copy over required secrets
  ansible.builtin.copy:
    src: "{{ playbook_dir}}/../secrets/{{ secret_name }}.vault"
    dest: "{{ container_directory }}/{{ container_name }}/secrets/{{ secret_name }}"
    mode: 0644
  loop: "{{ required_secrets }}"
  loop_control:
    loop_var: secret_name
