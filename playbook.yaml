- name: Server setup
  hosts: myservers
  become: true
  vars:
    zpool_name: tank
    dataset_nextcloud_name: nextcloud
    dataset_nextcloud_options:
      - compression=lz4
    dataset_db_name: mariadb
    dataset_db_options:
      - recordsize=16k
      - primarycache=metadata
      - compression=lz4
      - logbias=throughput
      - atime=off
  tasks:
    - name: Allow memory over commit
      ansible.posix.sysctl:
        name: vm.overcommit_memory
        value: "1"
    - name: Install required things
      block:
        - name: Add contrib and backports repositories
          ansible.builtin.apt_repository:
            repo: "{{ item }}"
          loop:
            - "deb http://deb.debian.org/debian {{ ansible_distribution_release }}-backports main contrib"
            - "deb-src http://deb.debian.org/debian {{ ansible_distribution_release }}-backports main contrib"
        - name: Install Linux Headers and update cache
          ansible.builtin.apt:
            name:
              - linux-headers-amd64
            update_cache: true
        - name: Install zfs and docker
          ansible.builtin.apt:
            update_cache: false
            name:
              - docker
              - docker-compose
              - zfsutils-linux
              - zfs-dkms
    - name: Find Drive configuration and check for pre-existing ZFS pools
      block:
        - name: Get the boot drive
          ansible.builtin.shell: df /boot | tail -1 | awk '{print $1}' | sed 's/[0-9]*$//'
          register: boot_drive
          changed_when: false
        - name: Get a list of drives that are not the boot drive
          ansible.builtin.shell: lsblk -dpn -I 8 -o NAME -l | sed "\&{{ boot_drive.stdout | quote }}&d"
          register: zpool_drives
          changed_when: false
        - name: Check existence of drives for zpool
          ansible.builtin.fail:
            msg: No additional drives were found on the system for ZFS use.
          when: zpool_drives.stdout_lines|length==0
        - name: Find any existing zpools
          ansible.builtin.shell: zpool import -N -d {{ zpool_drives.stdout_lines | join(" -d ") }}
          register: zpool_import_results
          changed_when: false
        - name: Check for existing zpools
#          TODO: Check this fails when a real pool exists
          ansible.builtin.fail:
            msg: Existing zpool found!
          when: zpool_import_results.stdout != ""